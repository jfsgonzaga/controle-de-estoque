<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Sistema de Controle de Estoque</h1>
            <p class="text-gray-600 mt-2">Gerencie seus produtos, veja o histórico e exporte relatórios.</p>
            <div id="auth-info" class="text-xs text-gray-500 mt-2"></div>
        </header>

        <main>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Produtos em Estoque</h2>
                    <div class="action-buttons-container flex flex-wrap gap-4 mt-4 md:mt-0">
                        <button id="viewHistoryBtn" class="w-full sm:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition">Ver Histórico</button>
                        <button id="exportPdfBtn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition">Exportar PDF</button>
                        <button id="addProductBtn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Adicionar Produto</button>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loader" class="text-center py-10">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">Carregando produtos...</p>
                </div>

                <!-- Product Table -->
                <div id="product-table-container" class="overflow-x-auto hidden">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cor</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Movimentação</th>
                                <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider pdf-hidden">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="divide-y divide-gray-200">
                            <!-- Product rows will be inserted here -->
                        </tbody>
                    </table>
                     <p id="no-products-message" class="text-center py-10 text-gray-500 hidden">Nenhum produto encontrado. Adicione um para começar.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop modal modal-hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-bold mb-6">Adicionar Novo Produto</h3>
            <form id="addProductForm">
                <div class="mb-4">
                    <label for="productSKU" class="block text-sm font-medium text-gray-700 mb-1">SKU (Código)</label>
                    <input type="text" id="productSKU" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                    <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="productColor" class="block text-sm font-medium text-gray-700 mb-1">Cor do Produto</label>
                    <input type="text" id="productColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="initialQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Inicial</label>
                    <input type="number" id="initialQuantity" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelAddProduct" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Movement Modal -->
    <div id="movementModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop modal modal-hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4">
            <h3 id="movementModalTitle" class="text-2xl font-bold mb-2">Registrar Movimento</h3>
            <p id="movementProductName" class="text-gray-600 mb-6"></p>
            <form id="movementForm">
                <input type="hidden" id="movementProductId">
                <input type="hidden" id="movementType">
                <div class="mb-6">
                    <label for="movementQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                    <input type="number" id="movementQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div id="error-message" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelMovement" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop modal modal-hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl m-4 flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Histórico de Movimentações</h3>
                <button type="button" id="cancelHistory" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="overflow-y-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
                </table>
                 <p id="no-history-message" class="text-center py-10 text-gray-500 hidden">Nenhuma movimentação encontrada.</p>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop modal modal-hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-bold text-red-600 mb-4">Confirmar Exclusão</h3>
            <p id="deleteConfirmText" class="text-gray-700 mb-6">Você tem certeza que deseja excluir o produto? Esta ação não pode ser desfeita.</p>
            <form id="deleteConfirmForm">
                <input type="hidden" id="deleteProductId">
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelDelete" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirmar Exclusão</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, runTransaction, query, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback config
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-stock-app';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let productsCollection;
        let movementsCollection;
        let movementsUnsubscribe = null;

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const productList = document.getElementById('product-list');
        const noProductsMessage = document.getElementById('no-products-message');
        
        // Modals
        const addProductModal = document.getElementById('addProductModal');
        const movementModal = document.getElementById('movementModal');
        const historyModal = document.getElementById('historyModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const historyList = document.getElementById('history-list');
        const noHistoryMessage = document.getElementById('no-history-message');

        // Forms
        const addProductForm = document.getElementById('addProductForm');
        const movementForm = document.getElementById('movementForm');
        const deleteConfirmForm = document.getElementById('deleteConfirmForm');
        
        // --- Modal Control & PDF Export ---
        const openModal = (modal) => modal.classList.remove('modal-hidden');
        const closeModal = (modal) => modal.classList.add('modal-hidden');

        document.getElementById('addProductBtn').addEventListener('click', () => openModal(addProductModal));
        document.getElementById('cancelAddProduct').addEventListener('click', () => closeModal(addProductModal));
        document.getElementById('cancelMovement').addEventListener('click', () => closeModal(movementModal));
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
        document.getElementById('viewHistoryBtn').addEventListener('click', showHistory);
        document.getElementById('cancelHistory').addEventListener('click', () => {
            closeModal(historyModal);
            if (movementsUnsubscribe) movementsUnsubscribe();
        });
        document.getElementById('cancelDelete').addEventListener('click', () => closeModal(deleteConfirmModal));
        deleteConfirmForm.addEventListener('submit', handleDeleteConfirmation);

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-info').textContent = `Conectado como: ${userId}`;
                
                productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
                movementsCollection = collection(db, `artifacts/${appId}/users/${userId}/movements`);
                
                listenForProducts();
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                document.getElementById('auth-info').textContent = 'Erro de autenticação.';
            }
        })();

        // --- Firestore Listeners ---
        function listenForProducts() {
            if (!productsCollection) return;
            onSnapshot(query(productsCollection), (snapshot) => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('product-table-container').classList.remove('hidden');
                
                if (snapshot.empty) {
                    productList.innerHTML = '';
                    noProductsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.add('hidden');
                    let productsHtml = '';
                    snapshot.docs.forEach(doc => {
                        const product = doc.data();
                        const formattedDate = product.lastMovementAt?.toDate() ? product.lastMovementAt.toDate().toLocaleString('pt-BR') : 'N/A';

                        productsHtml += `
                            <tr id="${doc.id}" class="hover:bg-gray-50">
                                <td class="py-4 px-6 text-gray-500">${product.sku}</td>
                                <td class="py-4 px-6 font-medium text-gray-900">${product.name}</td>
                                <td class="py-4 px-6 text-gray-500">${product.color || 'N/A'}</td>
                                <td class="py-4 px-6">
                                    <span class="font-semibold text-lg ${product.quantity <= 5 ? 'text-red-500' : 'text-gray-900'}">${product.quantity}</span>
                                </td>
                                <td class="py-4 px-6 text-gray-500">${formattedDate}</td>
                                <td class="py-4 px-6 text-center space-x-2 pdf-hidden">
                                    <button data-id="${doc.id}" data-name="${product.name}" class="entry-btn bg-green-100 text-green-800 font-bold py-1 px-3 rounded-full text-sm hover:bg-green-200 transition">Entrada</button>
                                    <button data-id="${doc.id}" data-name="${product.name}" data-quantity="${product.quantity}" class="exit-btn bg-red-100 text-red-800 font-bold py-1 px-3 rounded-full text-sm hover:bg-red-200 transition">Saída</button>
                                    <button data-id="${doc.id}" data-name="${product.name}" class="delete-btn bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-red-200 hover:text-red-800 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    productList.innerHTML = productsHtml;
                }
            });
        }

        // --- Event Delegation for Action Buttons ---
        productList.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const { id, name, quantity } = target.dataset;

            if (target.classList.contains('entry-btn')) {
                setupMovementModal('Entrada', id, name);
            } else if (target.classList.contains('exit-btn')) {
                setupMovementModal('Saída', id, name, parseInt(quantity, 10));
            } else if (target.classList.contains('delete-btn')) {
                setupDeleteModal(id, name);
            }
        });

        // --- Form Submissions ---
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('productName').value;
            const sku = document.getElementById('productSKU').value;
            const color = document.getElementById('productColor').value;
            const quantity = parseInt(document.getElementById('initialQuantity').value, 10);

            try {
                const newProdRef = doc(productsCollection);
                await setDoc(newProdRef, { name, sku, color, quantity, createdAt: new Date(), lastMovementAt: new Date() });
                addProductForm.reset();
                closeModal(addProductModal);
            } catch (error) {
                console.error("Error adding product: ", error);
                alert("Falha ao adicionar produto.");
            }
        });

        movementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('movementProductId').value;
            const type = document.getElementById('movementType').value;
            const quantity = parseInt(document.getElementById('movementQuantity').value, 10);
            const productRef = doc(productsCollection, productId);
            const errorMessage = document.getElementById('error-message');
            errorMessage.classList.add('hidden');

            try {
                await runTransaction(db, async (transaction) => {
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) throw "Produto não encontrado!";
                    
                    const currentQuantity = productDoc.data().quantity;
                    let newQuantity;
                    if (type === 'Entrada') {
                        newQuantity = currentQuantity + quantity;
                    } else {
                        if (currentQuantity < quantity) throw "Estoque insuficiente.";
                        newQuantity = currentQuantity - quantity;
                    }
                    
                    transaction.update(productRef, { quantity: newQuantity, lastMovementAt: new Date() });
                    transaction.set(doc(movementsCollection), { productId, productName: productDoc.data().name, type, quantity, timestamp: new Date() });
                });
                movementForm.reset();
                closeModal(movementModal);
            } catch (error) {
                console.error("Transaction failed: ", error);
                errorMessage.textContent = error.toString();
                errorMessage.classList.remove('hidden');
            }
        });

        async function handleDeleteConfirmation(e) {
            e.preventDefault();
            const productId = document.getElementById('deleteProductId').value;
            if (!productId) return;
            try {
                await deleteDoc(doc(productsCollection, productId));
                closeModal(deleteConfirmModal);
            } catch (error) {
                console.error("Error deleting product: ", error);
                alert("Falha ao excluir o produto.");
                closeModal(deleteConfirmModal);
            }
        }

        // --- Helper Functions ---
        function setupMovementModal(type, productId, productName) {
            document.getElementById('movementProductId').value = productId;
            document.getElementById('movementType').value = type;
            document.getElementById('movementProductName').textContent = productName;
            document.getElementById('movementModalTitle').textContent = `Registrar ${type}`;
            openModal(movementModal);
        }

        function setupDeleteModal(productId, productName) {
            document.getElementById('deleteProductId').value = productId;
            document.getElementById('deleteConfirmText').textContent = `Você tem certeza que deseja excluir o produto "${productName}"? Esta ação não pode ser desfeita.`;
            openModal(deleteConfirmModal);
        }

        function showHistory() {
            if (!movementsCollection) return;
            const q = query(movementsCollection);
            movementsUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    historyList.innerHTML = '';
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    noHistoryMessage.classList.add('hidden');
                    const movements = snapshot.docs.map(doc => doc.data());
                    movements.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    
                    historyList.innerHTML = movements.map(mov => {
                        const typeClass = mov.type === 'Entrada' ? 'text-green-600' : 'text-red-600';
                        const typeSymbol = mov.type === 'Entrada' ? '+' : '-';
                        return `
                            <tr>
                                <td class="py-4 px-6 text-sm text-gray-500">${mov.timestamp.toDate().toLocaleString('pt-BR')}</td>
                                <td class="py-4 px-6 text-sm font-medium text-gray-900">${mov.productName}</td>
                                <td class="py-4 px-6 text-sm font-semibold ${typeClass}">${mov.type}</td>
                                <td class="py-4 px-6 text-sm font-semibold ${typeClass}">${typeSymbol}${mov.quantity}</td>
                            </tr>
                        `;
                    }).join('');
                }
            });
            openModal(historyModal);
        }

        function exportToPDF() {
            const element = document.getElementById('product-table-container');
            const opt = {
              margin: [0.5, 0.5, 0.5, 0.5],
              filename: 'relatorio-de-estoque.pdf',
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, onclone: (doc) => doc.querySelectorAll('.pdf-hidden').forEach(el => el.style.display = 'none') },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().from(element).set(opt).save();
        }
    </script>
</body>
</html>
